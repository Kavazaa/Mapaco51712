<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Provas MAP vs. ACO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .file-input-label.has-file { background-color: #10B981; color: white; border-color: #10B981; }
        .lift-positive { color: #10B981; }
        .lift-negative { color: #EF4444; }
        .lift-neutral { color: #6B7280; }
        .score-above-avg { background-color: #ECFDF5; border-left-color: #10B981; }
        .score-below-avg { background-color: #FEF2F2; border-left-color: #EF4444; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        .sort-btn.active, .filter-btn.active { background-color: #4F46E5; color: white; }
        /* Toggle Switch CSS */
        #results-grid.hide-lift .lift-display { display: none; }
        #toggle-lift:checked ~ .dot { transform: translateX(100%); }
        #toggle-lift:checked ~ .block { background-color: #a5b4fc; } /* indigo-300 */
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Coluna da Esquerda: Controles e Análises Salvas -->
            <div class="lg:col-span-1 flex flex-col gap-6">
                <!-- Seção de Nova Análise -->
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">Nova Análise</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="analysis-name" class="block text-sm font-medium text-gray-700">Nome da Análise</label>
                            <input type="text" id="analysis-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Comparativo Q1 2024">
                        </div>
                        <div>
                            <label for="analysis-desc" class="block text-sm font-medium text-gray-700">Descrição</label>
                            <textarea id="analysis-desc" rows="2" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Detalhes sobre esta análise"></textarea>
                        </div>
                        <div>
                            <h3 class="font-semibold text-md mb-2 text-indigo-600">Planilha de Análise</h3>
                            <label for="analysis-file" class="file-input-label w-full flex items-center justify-center px-4 py-3 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:bg-gray-100 transition-all">
                                <span id="analysis-file-name">Carregar Planilha (com abas MAP e ACO)</span>
                            </label>
                            <input type="file" id="analysis-file" class="hidden" accept=".xlsx, .xls, .csv">
                        </div>
                        <button id="process-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-all">
                            Salvar e Analisar
                        </button>
                    </div>
                </div>

                <!-- Seção de Análises Salvas -->
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">Análises Salvas</h2>
                    <div id="saved-analyses-list" class="space-y-3 max-h-60 overflow-y-auto">
                        <!-- Análises salvas serão listadas aqui -->
                    </div>
                </div>

                 <!-- Seção de Métricas Globais -->
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">Métricas Globais</h2>
                    <div id="global-stats-container" class="space-y-4">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Média Geral de LIFT</p>
                            <p id="global-avg-lift" class="text-2xl font-bold text-indigo-600">--</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-600">Média Geral de NOTA</p>
                            <p id="global-avg-note" class="text-2xl font-bold text-teal-600">--</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Coluna da Direita: Resultados -->
            <div class="lg:col-span-2">
                <div id="results-section" class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 min-h-full hidden">
                    <div id="results-header" class="mb-2">
                        <h1 id="result-title" class="text-3xl font-bold text-gray-900"></h1>
                        <p id="result-desc" class="mt-1 text-gray-600"></p>
                    </div>

                     <!-- Stats da Análise Atual -->
                    <div id="current-analysis-stats" class="flex justify-center gap-8 my-4 p-4 bg-gray-50 rounded-lg border">
                        <div>
                            <p class="text-sm font-medium text-center text-gray-600">Média de LIFT</p>
                            <p id="avg-lift-stat" class="text-2xl font-bold text-indigo-600 text-center">--</p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-center text-gray-600">Média de NOTA</p>
                            <p id="avg-note-stat" class="text-2xl font-bold text-teal-600 text-center">--</p>
                        </div>
                    </div>
                    
                    <!-- Controles de Filtro e Exportação -->
                    <div id="controls-container" class="mb-6 p-4 rounded-xl bg-gray-50 border">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-start">
                            <!-- Filtro de Líder -->
                            <div>
                                <h3 class="font-semibold text-lg mb-2 text-center">Filtrar por Líder</h3>
                                <div id="leader-filters" class="flex flex-wrap justify-center gap-2"></div>
                            </div>
                            <!-- Filtro de Função -->
                             <div>
                                <h3 class="font-semibold text-lg mb-2 text-center">Filtrar por Função</h3>
                                <div id="role-filters" class="flex flex-wrap justify-center gap-2"></div>
                            </div>
                             <!-- Ordenação, Exportação e Visualização -->
                            <div class="space-y-4">
                                <div >
                                    <h3 class="font-semibold text-lg mb-2 text-center">Ordenar Por</h3>
                                    <div id="sort-buttons" class="flex flex-wrap justify-center gap-2">
                                        <button data-sort="lift-desc" class="sort-btn px-3 py-1.5 text-sm font-medium rounded-md bg-gray-200 hover:bg-gray-300">Melhor LIFT</button>
                                        <button data-sort="lift-asc" class="sort-btn px-3 py-1.5 text-sm font-medium rounded-md bg-gray-200 hover:bg-gray-300">Pior LIFT</button>
                                        <button data-sort="score-desc" class="sort-btn px-3 py-1.5 text-sm font-medium rounded-md bg-gray-200 hover:bg-gray-300">Melhor NOTA</button>
                                        <button data-sort="score-asc" class="sort-btn px-3 py-1.5 text-sm font-medium rounded-md bg-gray-200 hover:bg-gray-300">Pior NOTA</button>
                                    </div>
                                </div>
                                <div class="flex justify-around items-start pt-2">
                                    <div>
                                        <h3 class="font-semibold text-lg mb-2 text-center">Exportar</h3>
                                        <div class="flex justify-center gap-2">
                                            <button id="export-pdf-btn" class="px-3 py-1.5 text-sm font-medium rounded-md bg-red-100 text-red-700 hover:bg-red-200">PDF</button>
                                            <button id="export-excel-btn" class="px-3 py-1.5 text-sm font-medium rounded-md bg-green-100 text-green-700 hover:bg-green-200">Excel</button>
                                        </div>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-lg mb-2 text-center">Ver LIFT</h3>
                                        <label for="toggle-lift" class="flex items-center justify-center cursor-pointer">
                                            <div class="relative">
                                                <input type="checkbox" id="toggle-lift" class="sr-only">
                                                <div class="block bg-gray-300 w-12 h-7 rounded-full"></div>
                                                <div class="dot absolute left-1 top-1 bg-white w-5 h-5 rounded-full transition"></div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="message-area" class="text-center my-4"></div>
                    <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
                        <!-- Cards de resultado -->
                    </div>
                </div>
                 <div id="welcome-message" class="flex items-center justify-center bg-white p-6 rounded-2xl shadow-lg border border-gray-200 min-h-full">
                    <div class="text-center">
                        <h2 class="text-2xl font-bold text-gray-700">Bem-vindo!</h2>
                        <p class="mt-2 text-gray-500">Crie uma nova análise ou selecione uma análise salva para começar.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-lg font-bold">Confirmar Exclusão</h3>
            <p class="mt-2 text-sm text-gray-600">Você tem certeza que deseja excluir esta análise? Esta ação não pode ser desfeita.</p>
            <div class="mt-6 flex justify-end gap-3">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Excluir</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Elementos da UI
        const analysisFileInput = document.getElementById('analysis-file');
        const analysisFileName = document.getElementById('analysis-file-name');
        const processBtn = document.getElementById('process-btn');
        const messageArea = document.getElementById('message-area');
        const resultsSection = document.getElementById('results-section');
        const welcomeMessage = document.getElementById('welcome-message');
        const leaderFilters = document.getElementById('leader-filters');
        const roleFilters = document.getElementById('role-filters');
        const resultsGrid = document.getElementById('results-grid');
        const analysisNameInput = document.getElementById('analysis-name');
        const analysisDescInput = document.getElementById('analysis-desc');
        const savedAnalysesList = document.getElementById('saved-analyses-list');
        const resultTitle = document.getElementById('result-title');
        const resultDesc = document.getElementById('result-desc');
        const sortButtons = document.getElementById('sort-buttons');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const toggleLiftSwitch = document.getElementById('toggle-lift');
        const avgLiftStat = document.getElementById('avg-lift-stat');
        const avgNoteStat = document.getElementById('avg-note-stat');
        const globalAvgLift = document.getElementById('global-avg-lift');
        const globalAvgNote = document.getElementById('global-avg-note');

        // Estado da aplicação
        let currentResults = [];
        let currentAnalysisId = null;
        let currentLeaderFilter = 'Todos';
        let currentRoleFilter = 'Todos';
        let currentSort = 'none';
        const AVERAGE_SCORE = 7;

        // --- Funções de Lógica Principal ---

        const handleProcessAndSave = async () => {
            if (!analysisFileInput.files[0] || !analysisNameInput.value) {
                showMessage("Por favor, preencha o nome da análise e carregue a planilha.");
                return;
            }

            processBtn.disabled = true;
            processBtn.textContent = 'Processando...';
            clearMessage();

            try {
                const { mapData, acoData } = await parseWorkbook(analysisFileInput.files[0]);
                const combinedResults = combineData(mapData, acoData);

                if (combinedResults.length === 0) {
                    showMessage("Nenhum usuário correspondente encontrado nas abas MAP e ACO. Verifique a coluna 'user MONDAY'.");
                    return;
                }

                const newAnalysis = {
                    id: Date.now(),
                    name: analysisNameInput.value,
                    description: analysisDescInput.value,
                    createdAt: new Date().toISOString(),
                    results: combinedResults
                };

                saveAnalysis(newAnalysis);
                renderSavedAnalyses();
                loadAnalysis(newAnalysis.id);
                calculateAndDisplayGlobalAverages();

                analysisNameInput.value = '';
                analysisDescInput.value = '';
                analysisFileInput.value = null;
                updateFileLabel(analysisFileInput, analysisFileName);

            } catch (error) {
                showMessage(error.message);
            } finally {
                processBtn.disabled = false;
                processBtn.textContent = 'Salvar e Analisar';
            }
        };

        const combineData = (mapData, acoData) => {
            const mapDataMap = new Map(mapData.map(item => [item.name, item]));
            let combined = [];
            acoData.forEach(acoItem => {
                const mapItem = mapDataMap.get(acoItem.name);
                if (mapItem) {
                    const mapScore = mapItem.score;
                    const acoScore = acoItem.score;
                    const lift = (acoScore - mapScore) * 10;
                    
                    combined.push({
                        name: acoItem.name,
                        leader: acoItem.leader,
                        role: acoItem.role,
                        acoScore: acoScore,
                        mapScore: mapScore,
                        lift: lift
                    });
                }
            });
            return combined;
        };
        
        const loadAnalysis = (id) => {
            const analyses = getSavedAnalyses();
            const analysisToLoad = analyses.find(a => a.id == id);
            if (analysisToLoad) {
                currentAnalysisId = id;
                currentResults = analysisToLoad.results;
                resultTitle.textContent = analysisToLoad.name;
                resultDesc.textContent = analysisToLoad.description;
                
                welcomeMessage.classList.add('hidden');
                resultsSection.classList.remove('hidden');
                
                currentLeaderFilter = 'Todos';
                currentRoleFilter = 'Todos';
                currentSort = 'none';
                
                calculateAndDisplayCurrentAverages(currentResults);
                setupFilters(currentResults);
                renderFilteredResults();
                updateActiveSavedItem(id);
                document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            }
        };
        
        // --- Funções de Renderização e UI ---

        const renderFilteredResults = () => {
            let filteredData = [...currentResults];

            if (currentLeaderFilter !== 'Todos') {
                filteredData = filteredData.filter(r => r.leader === currentLeaderFilter);
            }

            if (currentRoleFilter !== 'Todos') {
                filteredData = filteredData.filter(r => r.role === currentRoleFilter);
            }

            if (currentSort === 'lift-desc') {
                filteredData.sort((a, b) => b.lift - a.lift);
            } else if (currentSort === 'lift-asc') {
                filteredData.sort((a, b) => a.lift - b.lift);
            } else if (currentSort === 'score-desc') {
                filteredData.sort((a, b) => b.acoScore - a.acoScore);
            } else if (currentSort === 'score-asc') {
                filteredData.sort((a, b) => a.acoScore - b.acoScore);
            }

            displayResults(filteredData);
        };
        
        const displayResults = (dataToDisplay) => {
            resultsGrid.innerHTML = '';
            if (dataToDisplay.length === 0) {
                resultsGrid.innerHTML = '<p class="text-gray-500 col-span-full text-center">Nenhum resultado para exibir com os filtros atuais.</p>';
                return;
            }
            dataToDisplay.forEach(result => {
                const liftClass = result.lift > 0 ? 'lift-positive' : result.lift < 0 ? 'lift-negative' : 'lift-neutral';
                const liftSign = result.lift > 0 ? '+' : '';
                const scoreClass = result.acoScore >= AVERAGE_SCORE ? 'score-above-avg' : 'score-below-avg';

                const card = `
                    <div class="result-card bg-white rounded-xl shadow-md border-l-4 ${scoreClass} p-5 flex flex-col justify-between transition-transform transform hover:scale-105" data-leader="${result.leader}" data-role="${result.role}">
                        <div>
                            <h4 class="font-bold text-lg text-gray-900 truncate">${result.name}</h4>
                            <p class="text-sm text-gray-500 mb-1">${result.role}</p>
                            <p class="text-sm text-gray-600 font-medium">Líder: <span class="font-semibold">${result.leader}</span></p>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200 text-center">
                            <p class="text-sm text-gray-500">NOTA</p>
                            <p class="text-3xl font-bold text-gray-800">${result.acoScore.toFixed(1)}</p>
                            <div class="lift-display mt-2 text-lg font-semibold ${liftClass} flex items-center justify-center">
                                ${result.lift > 0 ? '<svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>' : result.lift < 0 ? '<svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>' : ''}
                                <span>${liftSign}${result.lift.toFixed(1)}% LIFT</span>
                            </div>
                        </div>
                    </div>
                `;
                resultsGrid.innerHTML += card;
            });
        };

        const renderSavedAnalyses = () => {
            const analyses = getSavedAnalyses();
            savedAnalysesList.innerHTML = '';
            if (analyses.length === 0) {
                savedAnalysesList.innerHTML = '<p class="text-gray-500 text-sm text-center">Nenhuma análise salva.</p>';
                return;
            }
            analyses.forEach(analysis => {
                const item = document.createElement('div');
                item.className = 'saved-item flex justify-between items-center p-3 rounded-lg hover:bg-gray-100 cursor-pointer';
                item.dataset.id = analysis.id;
                item.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-800">${analysis.name}</p>
                        <p class="text-xs text-gray-500">Criado em: ${new Date(analysis.createdAt).toLocaleDateString('pt-BR')}</p>
                    </div>
                    <button data-id="${analysis.id}" class="delete-btn flex-shrink-0 p-2 text-gray-400 hover:text-red-600 rounded-full hover:bg-red-100">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                    </button>
                `;
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.delete-btn')) {
                        loadAnalysis(analysis.id);
                    }
                });
                savedAnalysesList.appendChild(item);
            });
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openConfirmModal(btn.dataset.id);
                });
            });
        };
        
        const setupFilters = (data) => {
            const createFilterButtons = (container, items, type, clickHandler) => {
                container.innerHTML = '';
                const uniqueItems = [...new Set(items)].sort();
                uniqueItems.forEach(item => {
                    const button = document.createElement('button');
                    button.textContent = item;
                    button.dataset[type] = item;
                    button.className = 'filter-btn px-3 py-1.5 text-sm font-medium rounded-full transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300';
                    button.addEventListener('click', clickHandler);
                    container.appendChild(button);
                });
            };

            const leaders = data.map(r => r.leader);
            createFilterButtons(leaderFilters, leaders, 'leader', handleLeaderFilterClick);

            const roles = data.map(r => r.role);
            createFilterButtons(roleFilters, roles, 'role', handleRoleFilterClick);
        };

        const handleLeaderFilterClick = (e) => {
            const clickedButton = e.target;
            const leader = clickedButton.dataset.leader;

            if (clickedButton.classList.contains('active')) {
                clickedButton.classList.remove('active');
                currentLeaderFilter = 'Todos';
            } else {
                document.querySelectorAll('#leader-filters .filter-btn').forEach(btn => btn.classList.remove('active'));
                clickedButton.classList.add('active');
                currentLeaderFilter = leader;
            }
            renderFilteredResults();
        };

        const handleRoleFilterClick = (e) => {
            const clickedButton = e.target;
            const role = clickedButton.dataset.role;

            if (clickedButton.classList.contains('active')) {
                clickedButton.classList.remove('active');
                currentRoleFilter = 'Todos';
            } else {
                document.querySelectorAll('#role-filters .filter-btn').forEach(btn => btn.classList.remove('active'));
                clickedButton.classList.add('active');
                currentRoleFilter = role;
            }
            renderFilteredResults();
        };

        const handleSort = (e) => {
            const clickedButton = e.target;
            const sortType = clickedButton.dataset.sort;
            if (!sortType) return;

            if (clickedButton.classList.contains('active')) {
                clickedButton.classList.remove('active');
                currentSort = 'none';
            } else {
                document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
                clickedButton.classList.add('active');
                currentSort = sortType;
            }
            
            renderFilteredResults();
        };

        // --- Funções de Média ---
        const calculateAndDisplayCurrentAverages = (results) => {
            if (results.length === 0) {
                avgLiftStat.textContent = '--';
                avgNoteStat.textContent = '--';
                return;
            }
            const totalLift = results.reduce((sum, r) => sum + r.lift, 0);
            const totalScore = results.reduce((sum, r) => sum + r.acoScore, 0);
            const avgLift = totalLift / results.length;
            const avgScore = totalScore / results.length;

            avgLiftStat.textContent = `${avgLift.toFixed(1)}%`;
            avgNoteStat.textContent = avgScore.toFixed(1);
        };

        const calculateAndDisplayGlobalAverages = () => {
            const allAnalyses = getSavedAnalyses();
            if (allAnalyses.length === 0) {
                globalAvgLift.textContent = '--';
                globalAvgNote.textContent = '--';
                return;
            }

            const allResults = allAnalyses.flatMap(analysis => analysis.results);
            if (allResults.length === 0) {
                globalAvgLift.textContent = '--';
                globalAvgNote.textContent = '--';
                return;
            }

            const totalLift = allResults.reduce((sum, r) => sum + r.lift, 0);
            const totalScore = allResults.reduce((sum, r) => sum + r.acoScore, 0);
            const avgLift = totalLift / allResults.length;
            const avgScore = totalScore / allResults.length;

            globalAvgLift.textContent = `${avgLift.toFixed(1)}%`;
            globalAvgNote.textContent = avgScore.toFixed(1);
        };


        // --- Funções de Exportação ---

        const exportToExcel = () => {
            if (currentResults.length === 0) return;
            const worksheet = XLSX.utils.json_to_sheet(currentResults);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Resultados");
            XLSX.writeFile(workbook, `${resultTitle.textContent.replace(/ /g,"_") || 'analise'}.xlsx`);
        };
        
        const exportToPDF = () => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const title = resultTitle.textContent;
            const grid = document.getElementById('results-grid');
            
            pdf.setFontSize(18);
            pdf.text(title, 105, 20, { align: 'center' });

            html2canvas(grid, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth() - 20;
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'PNG', 10, 30, pdfWidth, pdfHeight);
                pdf.save(`${title.replace(/ /g,"_") || 'analise'}.pdf`);
            });
        };

        // --- Funções Auxiliares e de `localStorage` ---

        const parseWorkbook = (file) => {
            return new Promise((resolve, reject) => {
                if (!file) reject(new Error("Arquivo não selecionado."));
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });

                        if (!workbook.SheetNames.includes('MAP') || !workbook.SheetNames.includes('ACO')) {
                            return reject(new Error("A planilha deve conter as abas 'MAP' e 'ACO'."));
                        }

                        const mapSheet = workbook.Sheets['MAP'];
                        const acoSheet = workbook.Sheets['ACO'];

                        const mapData = parseSheetData(mapSheet);
                        const acoData = parseSheetData(acoSheet);

                        resolve({ mapData, acoData });

                    } catch (err) {
                        reject(new Error("Erro ao ler o arquivo. Verifique o formato."));
                    }
                };
                reader.onerror = () => reject(new Error("Não foi possível ler o arquivo."));
                reader.readAsArrayBuffer(file);
            });
        };

        const parseSheetData = (worksheet) => {
            const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            const parsedData = json.slice(1).map(row => {
                const name = row[1] || '';      // Coluna B: user MONDAY
                const leader = row[2] || 'N/A'; // Coluna C: Lider
                const role = row[3] || 'N/A';   // Coluna D: Função
                const scoreRaw = row[17];       // Coluna R: Nota Final

                if (!name || scoreRaw === undefined || scoreRaw === null) return null;

                let score;

                // This logic robustly handles different formats for percentages from Excel.
                // Case 1: The value is a number between 0 and 1 (e.g., Excel cell with 50% might be read as 0.5).
                if (typeof scoreRaw === 'number' && scoreRaw >= 0 && scoreRaw <= 1) {
                    score = scoreRaw * 10; // Convert to a 0-10 scale (e.g., 0.5 * 10 = 5).
                } 
                // Case 2: The value is a string (e.g., "50%") or a whole number (e.g., 50).
                else {
                    // Convert to string, remove percentage sign, parse, and then divide by 10.
                    score = parseFloat(String(scoreRaw).replace('%', '')) / 10;
                }
                
                if (isNaN(score)) return null; // If conversion results in NaN, skip this row.

                return { name, leader, role, score };
            }).filter(Boolean); // Remove null entries.
            return parsedData;
        };

        const getSavedAnalyses = () => JSON.parse(localStorage.getItem('savedAnalyses') || '[]');
        const saveAnalysis = (analysis) => {
            const analyses = getSavedAnalyses();
            analyses.unshift(analysis);
            localStorage.setItem('savedAnalyses', JSON.stringify(analyses));
        };
        const deleteAnalysisFromStorage = (id) => {
            let analyses = getSavedAnalyses();
            analyses = analyses.filter(a => a.id != id);
            localStorage.setItem('savedAnalyses', JSON.stringify(analyses));
            renderSavedAnalyses();
            calculateAndDisplayGlobalAverages();
            if (currentAnalysisId == id) {
                resultsSection.classList.add('hidden');
                welcomeMessage.classList.remove('hidden');
                currentAnalysisId = null;
                currentResults = [];
            }
        };
        
        const openConfirmModal = (id) => {
            confirmModal.classList.remove('hidden');
            modalConfirmBtn.onclick = () => {
                deleteAnalysisFromStorage(id);
                confirmModal.classList.add('hidden');
            };
        };

        const updateFileLabel = (input, label) => {
            const fileName = input.files.length > 0 ? input.files[0].name : `Carregar Planilha (com abas MAP e ACO)`;
            label.textContent = fileName;
            label.parentElement.classList.toggle('has-file', input.files.length > 0);
        };
        
        const updateActiveSavedItem = (id) => {
             document.querySelectorAll('.saved-item').forEach(item => {
                item.classList.toggle('bg-indigo-100', item.dataset.id == id);
            });
        };

        const showMessage = (text, type = 'error') => {
            messageArea.innerHTML = `<div class="p-3 rounded-md ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}">${text}</div>`;
        };
        const clearMessage = () => { messageArea.innerHTML = ''; };

        const applyLiftVisibility = () => {
            const isLiftVisible = toggleLiftSwitch.checked;
            if (isLiftVisible) {
                resultsGrid.classList.remove('hide-lift');
            } else {
                resultsGrid.classList.add('hide-lift');
            }
        };

        // --- Inicialização e Event Listeners ---
        
        analysisFileInput.addEventListener('change', () => updateFileLabel(analysisFileInput, analysisFileName));
        processBtn.addEventListener('click', handleProcessAndSave);
        sortButtons.addEventListener('click', handleSort);
        exportPdfBtn.addEventListener('click', exportToPDF);
        exportExcelBtn.addEventListener('click', exportToExcel);
        modalCancelBtn.addEventListener('click', () => confirmModal.classList.add('hidden'));
        toggleLiftSwitch.addEventListener('change', () => {
            localStorage.setItem('isLiftVisible', toggleLiftSwitch.checked);
            applyLiftVisibility();
        });

        // Carregar preferências e dados iniciais
        const savedLiftPreference = localStorage.getItem('isLiftVisible');
        toggleLiftSwitch.checked = savedLiftPreference !== null ? JSON.parse(savedLiftPreference) : true;
        applyLiftVisibility();
        renderSavedAnalyses();
        calculateAndDisplayGlobalAverages();
    });
    </script>
</body>
</html>
